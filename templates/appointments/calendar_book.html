{% extends "base/base.html" %}
{% load static %}

{% block title %}Book Appointment - Dr. {{ doctor.user.get_full_name }} - Booking System{% endblock %}

{% block extra_css %}
<style>
    .calendar-day {
        min-height: 60px;
        transition: all 0.2s ease;
    }
    .calendar-day:hover {
        transform: translateY(-2px);
    }
    .calendar-day.has-slots {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        cursor: pointer;
    }
    .calendar-day.has-slots:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
    }
    .calendar-day.selected {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    .calendar-day.today {
        border: 2px solid #3b82f6;
    }
    .time-slot {
        transition: all 0.2s ease;
    }
    .time-slot:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .loading {
        display: none;
    }
    .loading.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Book Appointment</h1>
                <p class="text-lg text-gray-600 mt-2">
                    with <span class="font-semibold text-primary-600">Dr. {{ doctor.user.get_full_name }}</span>
                </p>
                <p class="text-sm text-gray-500">{{ doctor.specialty.name }}</p>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold text-primary-600">${{ doctor.consultation_fee }}</div>
                <div class="text-sm text-gray-500">Consultation Fee</div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Calendar Section -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow-xl rounded-xl border border-gray-100">
                <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-primary-50 to-blue-50">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-calendar-alt text-primary-600 mr-3"></i>
                        Select Date
                    </h2>
                </div>
                
                <div class="p-6">
                    <!-- Calendar Navigation -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-chevron-left text-gray-600"></i>
                        </button>
                        <h3 id="current-month" class="text-lg font-semibold text-gray-900">
                            {{ selected_date|date:"F Y" }}
                        </h3>
                        <button id="next-month" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-chevron-right text-gray-600"></i>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Sun</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Mon</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Tue</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Wed</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Thu</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Fri</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Sat</div>
                    </div>

                    <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                        <!-- Calendar days will be populated by JavaScript -->
                    </div>

                    <!-- Legend -->
                    <div class="flex items-center justify-center mt-6 space-x-6 text-sm">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-primary-600 rounded mr-2"></div>
                            <span class="text-gray-600">Available</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                            <span class="text-gray-600">Selected</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-gray-300 rounded mr-2"></div>
                            <span class="text-gray-600">Unavailable</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Slots Section -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow-xl rounded-xl border border-gray-100 sticky top-8">
                <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-clock text-green-600 mr-3"></i>
                        Available Times
                    </h2>
                </div>
                
                <div class="p-6">
                    <div id="selected-date-info" class="mb-4">
                        <div class="text-sm text-gray-500">Selected Date</div>
                        <div id="selected-date-text" class="text-lg font-semibold text-gray-900">
                            {{ selected_date|date:"l, F d, Y" }}
                        </div>
                    </div>

                    <!-- Time Slots Container -->
                    <div id="time-slots-container">
                        {% if available_slots %}
                            <div class="space-y-3">
                                {% for slot in available_slots %}
                                    <a href="{% url 'appointments:reserve_slot' slot.id %}" 
                                       class="time-slot w-full bg-primary-600 hover:bg-primary-700 text-white py-3 px-4 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center block">
                                        <i class="fas fa-bookmark mr-2"></i>
                                        {{ slot.start_time|time:"g:i A" }} - {{ slot.end_time|time:"g:i A" }}
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <div class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-calendar-times text-2xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">No Available Times</h3>
                                <p class="text-gray-600">No time slots available for this date.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simplified booking - direct links to reserve_slot -->
{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date('{{ selected_date|date:"Y-m-d" }}');
let doctorId = {{ doctor.id }};
let datesWithSlots = [
    {% for date in dates_with_slots %}
        '{{ date|date:"Y-m-d" }}'{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Debug: Log the dates
console.log('Dates with slots from server:', datesWithSlots);
console.log('Doctor ID:', doctorId);

// Initialize calendar
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing calendar...');
    console.log('Current date:', currentDate);
    console.log('Dates with slots:', datesWithSlots);
    renderCalendar();
});

function renderCalendar() {
    console.log('Rendering calendar...');
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonth = document.getElementById('current-month');
    
    // Clear previous calendar
    calendarGrid.innerHTML = '';
    
    // Set month header
    currentMonth.textContent = currentDate.toLocaleDateString('en-US', { 
        month: 'long', 
        year: 'numeric' 
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    // Generate calendar days
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day text-center py-2 rounded-lg cursor-pointer';
        
        // Check if date has slots
        const dateString = date.toISOString().split('T')[0];
        const hasSlots = datesWithSlots.includes(dateString);
        const isToday = date.toDateString() === new Date().toDateString();
        const isCurrentMonth = date.getMonth() === currentDate.getMonth();
        const isPast = date < new Date(new Date().setHours(0,0,0,0));
        
        console.log(`Date: ${dateString}, Has slots: ${hasSlots}, Is today: ${isToday}, Is current month: ${isCurrentMonth}`);
        
        if (hasSlots && !isPast) {
            dayElement.classList.add('has-slots');
        } else if (isCurrentMonth && !isPast) {
            dayElement.classList.add('bg-gray-50');
        } else if (isPast) {
            dayElement.classList.add('bg-gray-100', 'text-gray-400');
            dayElement.style.cursor = 'not-allowed';
        }
        
        if (isToday) {
            dayElement.classList.add('today');
        }
        
        if (!isCurrentMonth) {
            dayElement.classList.add('text-gray-400');
        }
        
        dayElement.textContent = date.getDate();
        
        // Only allow clicking on available dates
        if (hasSlots && !isPast) {
            dayElement.onclick = () => selectDate(date);
        }
        
        calendarGrid.appendChild(dayElement);
    }
    
    console.log('Calendar rendered with', calendarGrid.children.length, 'days');
}

function selectDate(date) {
    console.log('Date selected:', date);
    const dateString = date.toISOString().split('T')[0];
    console.log('Date string:', dateString);
    
    // Update selected date display
    document.getElementById('selected-date-text').textContent = 
        date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    
    // Redirect to the same page with the selected date
    window.location.href = `{% url 'appointments:calendar_book' doctor.id %}?date=${dateString}`;
}

// Simplified booking - no complex AJAX needed

// Calendar navigation
document.getElementById('prev-month').onclick = () => {
    console.log('Previous month clicked');
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
};

document.getElementById('next-month').onclick = () => {
    console.log('Next month clicked');
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
};
</script>
{% endblock %}
